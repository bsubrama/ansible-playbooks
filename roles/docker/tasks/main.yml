---

- name: add required packages to make apt repositories work over https
  apt: name={{ item }} state=present
  with_items:
    - "apt-transport-https"
    - "ca-certificates"
    - curl
    - "software-properties-common"
  sudo: yes

- name: get the current ubuntu release name
  command: lsb_release -cs
  register: release_name

- name: Add docker\'s apt key
  shell: curl -fsSL https://apt.dockerproject.org/gpg | apt-key add -
  sudo: yes

- name: add the docker repo
  shell: add-apt-repository "deb https://apt.dockerproject.org/repo/ ubuntu-{{ release_name.stdout }} main"
  sudo: yes

- name: update package list
  apt: update_cache=yes
  sudo: yes

- name: install docker
  apt: name="docker-engine=1.13.1-0~ubuntu-{{ release_name.stdout }}" state=present
  sudo: yes

- name: make sure the docker group exists
  group:
    name: docker
    state: present
  sudo: yes

- name: "add the current user and www-data to the docker group"
  user:
    name: "{{ item }}"
    groups: docker
    shell: /bin/bash
    append: yes
  with_items:
    - "{{ ansible_ssh_user }}"
    - "www-data"
  sudo: yes
